// ============================================================================
// ESQUEMAS DE VALIDACI√ìN - SISTEMA STREAMIT
// Base de datos: streamit_db
// ============================================================================
// Este script define e implementa los esquemas de validaci√≥n JSON Schema
// para las colecciones: movies, series, invoices_restructured
// ============================================================================

print("\n" + "=".repeat(80));
print("IMPLEMENTACI√ìN DE ESQUEMAS DE VALIDACI√ìN - STREAMIT DB");
print("=".repeat(80) + "\n");

// ============================================================================
// ESQUEMA 1: COLECCI√ìN MOVIES
// ============================================================================

print("üìΩÔ∏è  PASO 1: Creando esquema de validaci√≥n para 'movies'...\n");

db.runCommand({
  collMod: "movies",
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["title", "details", "_metadata"],
      properties: {
        _id: {
          bsonType: "objectId",
          description: "ID √∫nico de la pel√≠cula"
        },
        title: {
          bsonType: "string",
          minLength: 1,
          maxLength: 200,
          description: "T√≠tulo de la pel√≠cula (obligatorio, √∫nico, 1-200 caracteres)"
        },
        details: {
          bsonType: "object",
          required: ["year", "duration"],
          properties: {
            year: {
              bsonType: "int",
              minimum: 1888,
              maximum: 2030,
              description: "A√±o de producci√≥n (1888-2030)"
            },
            country: {
              bsonType: "string",
              maxLength: 100,
              description: "Pa√≠s de producci√≥n"
            },
            color: {
              bsonType: "string",
              enum: ["", "Color", "Black and White"],
              description: "Tipo de color de la pel√≠cula"
            },
            aspectRatio: {
              bsonType: ["double", "int", "null"],
              minimum: 0,
              maximum: 10,
              description: "Relaci√≥n de aspecto (0-10)"
            },
            contentRating: {
              bsonType: "string",
              maxLength: 20,
              description: "Clasificaci√≥n de contenido (G, PG, PG-13, R, etc.)"
            },
            budget: {
              bsonType: "decimal",
              description: "Presupuesto de la pel√≠cula en d√≥lares"
            },
            gross: {
              bsonType: "decimal",
              description: "Recaudaci√≥n bruta en d√≥lares"
            },
            director: {
              bsonType: "object",
              properties: {
                name: {
                  bsonType: "string",
                  maxLength: 150,
                  description: "Nombre del director"
                },
                facebookLikes: {
                  bsonType: "int",
                  minimum: 0,
                  description: "Likes en Facebook del director"
                }
              }
            },
            cast: {
              bsonType: "object",
              properties: {
                facebookLikes: {
                  bsonType: "int",
                  minimum: 0,
                  description: "Likes totales del elenco"
                },
                stars: {
                  bsonType: "array",
                  maxItems: 50,
                  items: {
                    bsonType: "object",
                    required: ["name"],
                    properties: {
                      name: {
                        bsonType: "string",
                        minLength: 1,
                        maxLength: 150,
                        description: "Nombre del actor/actriz"
                      },
                      facebookLikes: {
                        bsonType: "int",
                        minimum: 0,
                        description: "Likes en Facebook del actor"
                      }
                    }
                  },
                  description: "Lista de actores principales (m√°ximo 50)"
                }
              }
            },
            language: {
              bsonType: "string",
              maxLength: 50,
              description: "Idioma principal de la pel√≠cula"
            },
            genres: {
              bsonType: "array",
              maxItems: 10,
              uniqueItems: true,
              items: {
                bsonType: "string",
                minLength: 1,
                maxLength: 50
              },
              description: "G√©neros de la pel√≠cula (m√°ximo 10, √∫nicos)"
            },
            keywords: {
              bsonType: "array",
              maxItems: 50,
              items: {
                bsonType: "string",
                minLength: 1,
                maxLength: 100
              },
              description: "Palabras clave (m√°ximo 50)"
            },
            facesInPoster: {
              bsonType: "int",
              minimum: 0,
              maximum: 50,
              description: "N√∫mero de caras en el p√≥ster (0-50)"
            },
            imdbScore: {
              bsonType: ["double", "int"],
              minimum: 0,
              maximum: 10,
              description: "Puntuaci√≥n IMDB (0-10)"
            },
            imdbLink: {
              bsonType: "string",
              maxLength: 300,
              pattern: "^(|http://www\\.imdb\\.com/title/tt[0-9]+/\\?ref_=fn_tt_tt_1)$",
              description: "Enlace IMDB v√°lido o vac√≠o"
            },
            criticReviews: {
              bsonType: "int",
              minimum: 0,
              description: "N√∫mero de rese√±as de cr√≠ticos"
            },
            userReviews: {
              bsonType: "int",
              minimum: 0,
              description: "N√∫mero de rese√±as de usuarios"
            },
            votedUsers: {
              bsonType: "int",
              minimum: 0,
              description: "N√∫mero de usuarios que votaron"
            },
            facebookLikes: {
              bsonType: "int",
              minimum: 0,
              description: "Likes de la pel√≠cula en Facebook"
            },
            duration: {
              bsonType: "int",
              minimum: 1,
              maximum: 600,
              description: "Duraci√≥n en minutos (1-600)"
            }
          }
        },
        _metadata: {
          bsonType: "object",
          required: ["createdAt", "version"],
          properties: {
            createdAt: {
              bsonType: "date",
              description: "Fecha de creaci√≥n del registro"
            },
            version: {
              bsonType: "string",
              description: "Versi√≥n del esquema"
            },
            updatedAt: {
              bsonType: "date",
              description: "Fecha de √∫ltima actualizaci√≥n"
            }
          }
        }
      },
      additionalProperties: false
    }
  },
  validationLevel: "strict",
  validationAction: "error"
});

print("‚úÖ Esquema de 'movies' aplicado correctamente");
print("   ‚Ä¢ T√≠tulo obligatorio y √∫nico");
print("   ‚Ä¢ A√±o entre 1888-2030");
print("   ‚Ä¢ Duraci√≥n 1-600 minutos");
print("   ‚Ä¢ IMDB score 0-10");
print("   ‚Ä¢ G√©neros √∫nicos (m√°x. 10)");
print("   ‚Ä¢ Validaci√≥n estricta de tipos\n");

// ============================================================================
// ESQUEMA 2: COLECCI√ìN SERIES
// ============================================================================

print("üì∫ PASO 2: Creando esquema de validaci√≥n para 'series'...\n");

db.runCommand({
  collMod: "series",
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["title", "totalSeasons", "totalEpisodes", "_metadata"],
      properties: {
        _id: {
          bsonType: "objectId",
          description: "ID √∫nico de la serie"
        },
        title: {
          bsonType: "string",
          minLength: 1,
          maxLength: 200,
          description: "T√≠tulo de la serie (obligatorio, √∫nico, 1-200 caracteres)"
        },
        totalSeasons: {
          bsonType: "int",
          minimum: 1,
          maximum: 100,
          description: "N√∫mero total de temporadas (1-100)"
        },
        totalEpisodes: {
          bsonType: "int",
          minimum: 1,
          maximum: 10000,
          description: "N√∫mero total de episodios (1-10000)"
        },
        avgDuration: {
          bsonType: "int",
          minimum: 1,
          maximum: 600,
          description: "Duraci√≥n promedio de episodios en minutos (1-600)"
        },
        _metadata: {
          bsonType: "object",
          required: ["createdAt", "version"],
          properties: {
            createdAt: {
              bsonType: "date",
              description: "Fecha de creaci√≥n del registro"
            },
            version: {
              bsonType: "string",
              description: "Versi√≥n del esquema"
            },
            updatedAt: {
              bsonType: "date",
              description: "Fecha de √∫ltima actualizaci√≥n"
            }
          }
        }
      },
      additionalProperties: false
    }
  },
  validationLevel: "strict",
  validationAction: "error"
});

print("‚úÖ Esquema de 'series' aplicado correctamente");
print("   ‚Ä¢ T√≠tulo obligatorio y √∫nico");
print("   ‚Ä¢ 1-100 temporadas");
print("   ‚Ä¢ 1-10000 episodios totales");
print("   ‚Ä¢ Duraci√≥n promedio 1-600 minutos");
print("   ‚Ä¢ Validaci√≥n estricta de tipos\n");

// ============================================================================
// ESQUEMA 3: COLECCI√ìN INVOICES_RESTRUCTURED
// ============================================================================

print("üßæ PASO 3: Creando esquema de validaci√≥n para 'invoices_restructured'...\n");

db.runCommand({
  collMod: "invoices_restructured",
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["client", "contract", "billing", "chargeDate", "dumpDate", "total", "_metadata"],
      properties: {
        _id: {
          bsonType: "objectId",
          description: "ID √∫nico de la factura"
        },
        client: {
          bsonType: "object",
          required: ["customerCode", "name", "surname", "email", "phone", "dni", "birthDate"],
          properties: {
            customerCode: {
              bsonType: "string",
              pattern: "^[A-Z]{2}[0-9]{6}$",
              description: "C√≥digo de cliente: 2 letras may√∫sculas + 6 d√≠gitos (ej: AB123456)"
            },
            name: {
              bsonType: "string",
              minLength: 1,
              maxLength: 100,
              description: "Nombre del cliente (obligatorio)"
            },
            surname: {
              bsonType: "string",
              minLength: 1,
              maxLength: 150,
              description: "Apellido(s) del cliente (obligatorio)"
            },
            email: {
              bsonType: "string",
              pattern: "^[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,}$",
              maxLength: 100,
              description: "Email v√°lido en min√∫sculas"
            },
            phone: {
              bsonType: "long",
              minimum: 100000000,
              maximum: 999999999999,
              description: "Tel√©fono de 9-12 d√≠gitos"
            },
            dni: {
              bsonType: "string",
              pattern: "^[0-9]{8}[A-Z]$",
              description: "DNI espa√±ol: 8 d√≠gitos + letra may√∫scula"
            },
            birthDate: {
              bsonType: "date",
              description: "Fecha de nacimiento (debe ser en el pasado)"
            },
            age: {
              bsonType: "int",
              minimum: 18,
              maximum: 120,
              description: "Edad del cliente (18-120 a√±os)"
            }
          },
          additionalProperties: false
        },
        contract: {
          bsonType: "object",
          required: ["contractId", "startDate", "product"],
          properties: {
            contractId: {
              bsonType: "string",
              pattern: "^C[0-9]{8}$",
              description: "ID de contrato: C + 8 d√≠gitos"
            },
            startDate: {
              bsonType: "date",
              description: "Fecha de inicio del contrato"
            },
            endDate: {
              bsonType: ["date", "null"],
              description: "Fecha de fin del contrato (puede ser null si est√° activo)"
            },
            address: {
              bsonType: "string",
              maxLength: 200,
              description: "Direcci√≥n del cliente"
            },
            zip: {
              bsonType: ["string", "int"],
              description: "C√≥digo postal"
            },
            town: {
              bsonType: "string",
              maxLength: 100,
              description: "Ciudad/Localidad"
            },
            country: {
              bsonType: "string",
              maxLength: 100,
              description: "Pa√≠s"
            },
            product: {
              bsonType: "object",
              required: ["reference", "type"],
              properties: {
                reference: {
                  bsonType: "string",
                  pattern: "^(BASIC|STANDARD|PREMIUM|ENTERPRISE)-(MONTHLY|DAILY|PPM|PPC)$",
                  description: "Referencia del producto (TIPO-MODALIDAD)"
                },
                type: {
                  bsonType: "string",
                  enum: ["BASIC", "STANDARD", "PREMIUM", "ENTERPRISE"],
                  description: "Tipo de producto"
                },
                monthlyFee: {
                  bsonType: "decimal",
                  description: "Cuota mensual (>= 0)"
                },
                costPerDay: {
                  bsonType: "decimal",
                  description: "Coste por d√≠a (>= 0)"
                },
                costPerMinute: {
                  bsonType: "decimal",
                  description: "Coste por minuto (>= 0)"
                },
                costPerContent: {
                  bsonType: "decimal",
                  description: "Coste por contenido (>= 0)"
                },
                zapping: {
                  bsonType: "bool",
                  description: "Indica si tiene zapping"
                },
                promotion: {
                  bsonType: "string",
                  maxLength: 100,
                  description: "C√≥digo de promoci√≥n aplicada"
                }
              },
              additionalProperties: false
            }
          },
          additionalProperties: false
        },
        billing: {
          bsonType: "date",
          description: "Per√≠odo de facturaci√≥n (primer d√≠a del mes)"
        },
        chargeDate: {
          bsonType: "date",
          description: "Fecha de cargo de la factura"
        },
        dumpDate: {
          bsonType: "date",
          description: "Fecha de exportaci√≥n de la factura"
        },
        total: {
          bsonType: "decimal",
          description: "Total de la factura (>= 0)"
        },
        contentStats: {
          bsonType: "object",
          properties: {
            totalMovies: {
              bsonType: "int",
              minimum: 0,
              description: "N√∫mero de pel√≠culas en la factura"
            },
            totalSeries: {
              bsonType: "int",
              minimum: 0,
              description: "N√∫mero de series en la factura"
            },
            totalContent: {
              bsonType: "int",
              minimum: 0,
              description: "Total de contenidos (pel√≠culas + series)"
            }
          }
        },
        movies: {
          bsonType: "array",
          items: {
            bsonType: "object",
            required: ["movieId", "date", "viewingPct"],
            properties: {
              movieId: {
                bsonType: "objectId",
                description: "Referencia a la colecci√≥n 'movies'"
              },
              date: {
                bsonType: "date",
                description: "Fecha de visualizaci√≥n"
              },
              time: {
                bsonType: "string",
                pattern: "^([0-1][0-9]|2[0-3]):[0-5][0-9]$",
                description: "Hora de visualizaci√≥n (HH:MM)"
              },
              viewingPct: {
                bsonType: ["int", "double"],
                minimum: 0,
                maximum: 100,
                description: "Porcentaje visto (0-100)"
              },
              license: {
                bsonType: "object",
                properties: {
                  date: {
                    bsonType: ["date", "null"],
                    description: "Fecha de licencia"
                  },
                  time: {
                    bsonType: "string",
                    description: "Hora de licencia"
                  }
                }
              }
            }
          },
          description: "Lista de pel√≠culas vistas en este per√≠odo"
        },
        series: {
          bsonType: "array",
          items: {
            bsonType: "object",
            required: ["seriesId", "season", "episode", "date", "viewingPct"],
            properties: {
              seriesId: {
                bsonType: "objectId",
                description: "Referencia a la colecci√≥n 'series'"
              },
              season: {
                bsonType: "int",
                minimum: 1,
                description: "N√∫mero de temporada (>= 1)"
              },
              episode: {
                bsonType: "int",
                minimum: 1,
                description: "N√∫mero de episodio (>= 1)"
              },
              date: {
                bsonType: "date",
                description: "Fecha de visualizaci√≥n"
              },
              time: {
                bsonType: "string",
                pattern: "^([0-1][0-9]|2[0-3]):[0-5][0-9]$",
                description: "Hora de visualizaci√≥n (HH:MM)"
              },
              viewingPct: {
                bsonType: ["int", "double"],
                minimum: 0,
                maximum: 100,
                description: "Porcentaje visto (0-100)"
              },
              license: {
                bsonType: "object",
                properties: {
                  date: {
                    bsonType: ["date", "null"],
                    description: "Fecha de licencia"
                  },
                  time: {
                    bsonType: "string",
                    description: "Hora de licencia"
                  }
                }
              }
            }
          },
          description: "Lista de episodios de series vistos en este per√≠odo"
        },
        _metadata: {
          bsonType: "object",
          required: ["restructuredAt", "version"],
          properties: {
            restructuredAt: {
              bsonType: "date",
              description: "Fecha de reestructuraci√≥n"
            },
            version: {
              bsonType: "string",
              description: "Versi√≥n del esquema"
            }
          }
        }
      },
      additionalProperties: false
    }
  },
  validationLevel: "strict",
  validationAction: "error"
});

print("‚úÖ Esquema de 'invoices_restructured' aplicado correctamente");
print("   ‚Ä¢ C√≥digo cliente: 2 letras + 6 d√≠gitos");
print("   ‚Ä¢ DNI espa√±ol: 8 d√≠gitos + letra");
print("   ‚Ä¢ Email en min√∫sculas");
print("   ‚Ä¢ Edad 18-120 a√±os");
print("   ‚Ä¢ Referencias a movies y series");
print("   ‚Ä¢ Viewing % entre 0-100");
print("   ‚Ä¢ Validaci√≥n estricta de tipos\n");

// ============================================================================
// VALIDACIONES ADICIONALES CON √çNDICES √öNICOS
// ============================================================================

print("üîê PASO 4: Aplicando restricciones de unicidad...\n");

// √çndice √∫nico para movies.title
try {
  db.movies.createIndex({ title: 1 }, { unique: true });
  print("‚úÖ √çndice √∫nico en 'movies.title'");
} catch (e) {
  print("‚ö†Ô∏è  √çndice √∫nico en 'movies.title' ya existe");
}

// √çndice √∫nico para series.title
try {
  db.series.createIndex({ title: 1 }, { unique: true });
  print("‚úÖ √çndice √∫nico en 'series.title'");
} catch (e) {
  print("‚ö†Ô∏è  √çndice √∫nico en 'series.title' ya existe");
}

// √çndice √∫nico para invoices_restructured: combinaci√≥n cliente + fecha
try {
  db.invoices_restructured.createIndex(
    { "client.customerCode": 1, "billing": 1 },
    { unique: true, name: "unique_customer_billing" }
  );
  print("‚úÖ √çndice √∫nico en 'customer + billing'");
} catch (e) {
  print("‚ö†Ô∏è  √çndice √∫nico en 'customer + billing' ya existe");
}

// ============================================================================
// PRUEBAS DE VALIDACI√ìN
// ============================================================================

print("\n" + "=".repeat(80));
print("PRUEBAS DE VALIDACI√ìN");
print("=".repeat(80) + "\n");

print("üß™ Ejecutando pruebas de validaci√≥n...\n");

var testsPassed = 0;
var testsFailed = 0;

// Test 1: Pel√≠cula inv√°lida (a√±o fuera de rango)
print("Test 1: Pel√≠cula con a√±o inv√°lido (1800)...");
try {
  db.movies.insertOne({
    title: "TEST_INVALID_YEAR",
    details: {
      year: 1800, // Fuera de rango
      duration: 120
    },
    _metadata: {
      createdAt: new Date(),
      version: "1.0"
    }
  });
  print("‚ùå FALLO: Se permiti√≥ insertar a√±o inv√°lido");
  testsFailed++;
  db.movies.deleteOne({ title: "TEST_INVALID_YEAR" });
} catch (e) {
  print("‚úÖ √âXITO: A√±o inv√°lido rechazado correctamente");
  testsPassed++;
}

// Test 2: Serie inv√°lida (temporadas = 0)
print("Test 2: Serie con 0 temporadas...");
try {
  db.series.insertOne({
    title: "TEST_INVALID_SEASONS",
    totalSeasons: 0, // M√≠nimo es 1
    totalEpisodes: 10,
    _metadata: {
      createdAt: new Date(),
      version: "1.0"
    }
  });
  print("‚ùå FALLO: Se permiti√≥ insertar 0 temporadas");
  testsFailed++;
  db.series.deleteOne({ title: "TEST_INVALID_SEASONS" });
} catch (e) {
  print("‚úÖ √âXITO: 0 temporadas rechazado correctamente");
  testsPassed++;
}

// Test 3: Factura inv√°lida (email sin @)
print("Test 3: Factura con email inv√°lido...");
try {
  db.invoices_restructured.insertOne({
    client: {
      customerCode: "AB123456",
      name: "Test",
      surname: "User",
      email: "invalidemail.com", // Sin @
      phone: NumberLong("600123456"),
      dni: "12345678A",
      birthDate: new Date("1990-01-01")
    },
    contract: {
      contractId: "C12345678",
      startDate: new Date(),
      product: {
        reference: "BASIC-MONTHLY",
        type: "BASIC"
      }
    },
    billing: new Date(),
    chargeDate: new Date(),
    dumpDate: new Date(),
    total: NumberDecimal("9.99"),
    _metadata: {
      restructuredAt: new Date(),
      version: "2.0"
    }
  });
  print("‚ùå FALLO: Se permiti√≥ insertar email sin @");
  testsFailed++;
  db.invoices_restructured.deleteOne({ "client.customerCode": "AB123456" });
} catch (e) {
  print("‚úÖ √âXITO: Email inv√°lido rechazado correctamente");
  testsPassed++;
}

// Test 4: Factura inv√°lida (viewingPct > 100)
print("Test 4: Factura con viewingPct > 100...");
try {
  db.invoices_restructured.insertOne({
    client: {
      customerCode: "AB999999",
      name: "Test",
      surname: "User",
      email: "test@example.com",
      phone: NumberLong("600123456"),
      dni: "12345678A",
      birthDate: new Date("1990-01-01"),
      age: 34
    },
    contract: {
      contractId: "C99999999",
      startDate: new Date(),
      product: {
        reference: "BASIC-MONTHLY",
        type: "BASIC"
      }
    },
    billing: new Date(),
    chargeDate: new Date(),
    dumpDate: new Date(),
    total: NumberDecimal("9.99"),
    movies: [{
      movieId: ObjectId(),
      date: new Date(),
      viewingPct: 150 // > 100
    }],
    series: [],
    _metadata: {
      restructuredAt: new Date(),
      version: "2.0"
    }
  });
  print("‚ùå FALLO: Se permiti√≥ insertar viewingPct > 100");
  testsFailed++;
  db.invoices_restructured.deleteOne({ "client.customerCode": "AB999999" });
} catch (e) {
  print("‚úÖ √âXITO: viewingPct > 100 rechazado correctamente");
  testsPassed++;
}

// Test 5: Cliente con edad < 18
print("Test 5: Cliente con edad menor de 18 a√±os...");
try {
  db.invoices_restructured.insertOne({
    client: {
      customerCode: "AB888888",
      name: "Test",
      surname: "Minor",
      email: "minor@example.com",
      phone: NumberLong("600123456"),
      dni: "12345678B",
      birthDate: new Date("2010-01-01"),
      age: 15 // < 18
    },
    contract: {
      contractId: "C88888888",
      startDate: new Date(),
      product: {
        reference: "BASIC-MONTHLY",
        type: "BASIC"
      }
    },
    billing: new Date(),
    chargeDate: new Date(),
    dumpDate: new Date(),
    total: NumberDecimal("9.99"),
    _metadata: {
      restructuredAt: new Date(),
      version: "2.0"
    }
  });
  print("‚ùå FALLO: Se permiti√≥ insertar edad < 18");
  testsFailed++;
  db.invoices_restructured.deleteOne({ "client.customerCode": "AB888888" });
} catch (e) {
  print("‚úÖ √âXITO: Edad < 18 rechazada correctamente");
  testsPassed++;
}

// ============================================================================
// RESUMEN FINAL
// ============================================================================

print("\n" + "=".repeat(80));
print("RESUMEN DE IMPLEMENTACI√ìN");
print("=".repeat(80) + "\n");

print("üìã ESQUEMAS APLICADOS:");
print("   ‚úÖ movies: " + (db.getCollectionInfos({name: "movies"})[0].options.validator ? "ACTIVO" : "NO ACTIVO"));
print("   ‚úÖ series: " + (db.getCollectionInfos({name: "series"})[0].options.validator ? "ACTIVO" : "NO ACTIVO"));
print("   ‚úÖ invoices_restructured: " + (db.getCollectionInfos({name: "invoices_restructured"})[0].options.validator ? "ACTIVO" : "NO ACTIVO"));

print("\nüîê RESTRICCIONES DE UNICIDAD:");
print("   ‚úÖ movies.title (√∫nico)");
print("   ‚úÖ series.title (√∫nico)");
print("   ‚úÖ customer + billing (combinaci√≥n √∫nica)");

print("\nüß™ RESULTADOS DE PRUEBAS:");
print("   ‚úÖ Pruebas exitosas: " + testsPassed);
print("   ‚ùå Pruebas fallidas: " + testsFailed);
print("   üìä Total: " + (testsPassed + testsFailed));

print("\n‚ú® REGLAS DE CONSISTENCIA IMPLEMENTADAS:");
print("   ‚Ä¢ Pel√≠culas:");
print("     - T√≠tulo obligatorio (1-200 caracteres)");
print("     - A√±o entre 1888-2030");
print("     - Duraci√≥n 1-600 minutos");
print("     - IMDB score 0-10");
print("     - G√©neros √∫nicos (m√°ximo 10)");
print("     - Validaci√≥n de enlaces IMDB");
print("");
print("   ‚Ä¢ Series:");
print("     - T√≠tulo obligatorio (1-200 caracteres)");
print("     - 1-100 temporadas");
print("     - 1-10000 episodios totales");
print("     - Duraci√≥n promedio 1-600 minutos");
print("");
print("   ‚Ä¢ Facturas:");
print("     - C√≥digo cliente: formato AB123456");
print("     - DNI espa√±ol: 8 d√≠gitos + letra");
print("     - Email v√°lido en min√∫sculas");
print("     - Edad 18-120 a√±os");
print("     - Viewing % entre 0-100");
print("     - Referencias v√°lidas a movies/series");
print("     - Fechas coherentes (birthDate < hoy)");
print("     - Productos con tipos v√°lidos");
print("     - Importes >= 0");

print("\n‚öôÔ∏è  CONFIGURACI√ìN:");
print("   ‚Ä¢ Validation Level: STRICT");
print("   ‚Ä¢ Validation Action: ERROR");
print("   ‚Ä¢ Additional Properties: FALSE");

print("\n" + "=".repeat(80));
print("‚úÖ ESQUEMAS DE VALIDACI√ìN IMPLEMENTADOS EXITOSAMENTE");
print("=".repeat(80) + "\n");

// Mostrar estad√≠sticas de las colecciones
print("üìä ESTAD√çSTICAS DE COLECCIONES:");
var moviesCount = db.movies.countDocuments({});
var seriesCount = db.series.countDocuments({});
var invoicesCount = db.invoices_restructured.countDocuments({});

print("   ‚Ä¢ movies: " + moviesCount.toLocaleString() + " documentos");
print("   ‚Ä¢ series: " + seriesCount.toLocaleString() + " documentos");
print("   ‚Ä¢ invoices_restructured: " + invoicesCount.toLocaleString() + " documentos");

print("\nüìñ GU√çA DE USO:");
print("   1. Ejecutar despu√©s de la reestructuraci√≥n");
print("   2. Los esquemas validan autom√°ticamente inserts/updates");
print("   3. Errores de validaci√≥n retornan mensajes descriptivos");
print("   4. Para modificar esquemas: usar collMod nuevamente");

print("\nüí° EJEMPLOS DE VALIDACI√ìN:");
print("\n   // Inserci√≥n v√°lida de pel√≠cula:");
print("   db.movies.insertOne({");
print("     title: 'Inception',");
print("     details: {");
print("       year: 2010,");
print("       duration: 148,");
print("       imdbScore: 8.8");
print("     },");
print("     _metadata: { createdAt: new Date(), version: '1.0' }");
print("   });");

print("\n   // Inserci√≥n inv√°lida (a√±o fuera de rango):");
print("   db.movies.insertOne({");
print("     title: 'Old Movie',");
print("     details: { year: 1800, duration: 90 } // ‚ùå Error: a√±o < 1888");
print("   });");

print("\nüîç VERIFICACI√ìN DE ESQUEMAS:");
print("   // Ver esquema de una colecci√≥n:");
print("   db.getCollectionInfos({name: 'movies'})[0].options.validator;");

print("\n   // Listar todas las colecciones con validaci√≥n:");
print("   db.getCollectionInfos().forEach(function(coll) {");
print("     if (coll.options.validator) {");
print("       print(coll.name + ' tiene validaci√≥n activa');");
print("     }");
print("   });");

print("\nüõ†Ô∏è  MANTENIMIENTO:");
print("   // Desactivar validaci√≥n temporalmente:");
print("   db.runCommand({ collMod: 'movies', validationLevel: 'off' });");

print("\n   // Reactivar validaci√≥n:");
print("   db.runCommand({ collMod: 'movies', validationLevel: 'strict' });");

print("\n   // Eliminar validaci√≥n:");
print("   db.runCommand({ collMod: 'movies', validator: {} });");

print("\n" + "=".repeat(80));
print("FECHA DE IMPLEMENTACI√ìN: " + new Date().toISOString());
print("VERSI√ìN DEL ESQUEMA: 1.0");
print("=".repeat(80) + "\n");