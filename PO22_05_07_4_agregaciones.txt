// ============================================================================
// CONSULTAS DE AGREGACI√ìN - SISTEMA STREAMIT
// Base de datos: streamit_db
// ============================================================================
// Implementaci√≥n de casos de uso anal√≠ticos sobre el modelo reestructurado
// Colecciones: movies, series, invoices_restructured
// ============================================================================

print("\n" + "=".repeat(80));
print("CONSULTAS DE AGREGACI√ìN - STREAMIT DB");
print("=".repeat(80) + "\n");

// ============================================================================
// Q1) SERIAL LOVERS
// Detectar clientes que han visionado al menos una temporada completa de una serie
// ============================================================================

print("üì∫ Q1: SERIAL LOVERS - Clientes que completaron temporadas\n");
print("-".repeat(80));

db.invoices_restructured.aggregate([
  // Expandir el array de series para analizar cada visualizaci√≥n
  { $unwind: "$series" },
  
  // Agrupar por cliente, serie y temporada
  {
    $group: {
      _id: {
        customerCode: "$client.customerCode",
        clientName: "$client.name",
        clientSurname: "$client.surname",
        seriesId: "$series.seriesId",
        season: "$series.season"
      },
      episodesWatched: { $addToSet: "$series.episode" },
      avgViewingPct: { $avg: "$series.viewingPct" }
    }
  },
  
  // Obtener informaci√≥n de la serie
  {
    $lookup: {
      from: "series",
      localField: "_id.seriesId",
      foreignField: "_id",
      as: "seriesInfo"
    }
  },
  
  { $unwind: "$seriesInfo" },
  
  // Contar episodios vistos
  {
    $addFields: {
      episodesWatchedCount: { $size: "$episodesWatched" }
    }
  },
  
  // Filtrar temporadas con visionado significativo (>70% de episodios)
  // Asumimos aprox. totalEpisodes / totalSeasons episodios por temporada
  {
    $addFields: {
      avgEpisodesPerSeason: {
        $divide: ["$seriesInfo.totalEpisodes", "$seriesInfo.totalSeasons"]
      }
    }
  },
  
  // Considerar "temporada completa" si vio al menos 70% de los episodios
  {
    $match: {
      $expr: {
        $gte: [
          "$episodesWatchedCount",
          { $multiply: ["$avgEpisodesPerSeason", 0.7] }
        ]
      },
      avgViewingPct: { $gte: 70 } // Vio al menos 70% de cada episodio
    }
  },
  
  // Agrupar por cliente
  {
    $group: {
      _id: "$_id.customerCode",
      clientName: { $first: "$_id.clientName" },
      clientSurname: { $first: "$_id.clientSurname" },
      completedSeasons: {
        $push: {
          series: "$seriesInfo.title",
          season: "$_id.season",
          episodesWatched: "$episodesWatchedCount",
          avgViewingPct: { $round: ["$avgViewingPct", 2] }
        }
      },
      totalCompletedSeasons: { $sum: 1 }
    }
  },
  
  // Ordenar por n√∫mero de temporadas completadas
  { $sort: { totalCompletedSeasons: -1 } },
  
  // Limitar a top 20
  { $limit: 20 },
  
  // Formato final
  {
    $project: {
      _id: 0,
      customerCode: "$_id",
      client: {
        $concat: ["$clientName", " ", "$clientSurname"]
      },
      totalCompletedSeasons: 1,
      completedSeasons: 1
    }
  }
]).forEach(doc => {
  print(`Cliente: ${doc.client} (${doc.customerCode})`);
  print(`  Temporadas completadas: ${doc.totalCompletedSeasons}`);
  doc.completedSeasons.forEach(season => {
    print(`    ‚Ä¢ ${season.series} - Temporada ${season.season}`);
    print(`      Episodios vistos: ${season.episodesWatched}, Promedio visto: ${season.avgViewingPct}%`);
  });
  print("");
});

print("‚úÖ Q1 completada\n");

// ============================================================================
// Q2) APELLIDOS COMUNES
// Obtener el apellido m√°s frecuente por pa√≠s de contrato
// ============================================================================

print("üåç Q2: APELLIDOS COMUNES - Apellido m√°s frecuente por pa√≠s\n");
print("-".repeat(80));

db.invoices_restructured.aggregate([
  // Extraer primer apellido (antes del primer espacio)
  {
    $addFields: {
      firstSurname: {
        $arrayElemAt: [
          { $split: ["$client.surname", " "] },
          0
        ]
      }
    }
  },
  
  // Agrupar por pa√≠s y apellido
  {
    $group: {
      _id: {
        country: "$contract.country",
        surname: "$firstSurname"
      },
      count: { $sum: 1 },
      clients: {
        $addToSet: {
          code: "$client.customerCode",
          name: "$client.name"
        }
      }
    }
  },
  
  // Ordenar por pa√≠s y frecuencia
  { $sort: { "_id.country": 1, count: -1 } },
  
  // Agrupar por pa√≠s y tomar el apellido m√°s frecuente
  {
    $group: {
      _id: "$_id.country",
      mostCommonSurname: { $first: "$_id.surname" },
      frequency: { $first: "$count" },
      sampleClients: { $first: { $slice: ["$clients", 3] } },
      allSurnames: {
        $push: {
          surname: "$_id.surname",
          count: "$count"
        }
      }
    }
  },
  
  // Ordenar por pa√≠s
  { $sort: { _id: 1 } },
  
  // Formato final
  {
    $project: {
      _id: 0,
      country: "$_id",
      mostCommonSurname: 1,
      frequency: 1,
      sampleClients: 1,
      top5Surnames: { $slice: ["$allSurnames", 5] }
    }
  }
]).forEach(doc => {
  print(`Pa√≠s: ${doc.country}`);
  print(`  Apellido m√°s com√∫n: ${doc.mostCommonSurname} (${doc.frequency} clientes)`);
  print(`  Ejemplos de clientes:`);
  doc.sampleClients.forEach(client => {
    print(`    ‚Ä¢ ${client.name} ${doc.mostCommonSurname} (${client.code})`);
  });
  print(`  Top 5 apellidos:`);
  doc.top5Surnames.forEach((s, idx) => {
    print(`    ${idx + 1}. ${s.surname}: ${s.count}`);
  });
  print("");
});

print("‚úÖ Q2 completada\n");

// ============================================================================
// Q3) ACTORES POPULARES
// Top-5 de actores m√°s vistos en Espa√±a
// ============================================================================

print("üé≠ Q3: ACTORES POPULARES - Top-5 actores m√°s vistos en Espa√±a\n");
print("-".repeat(80));

db.invoices_restructured.aggregate([
  // Filtrar solo contratos de Espa√±a
  { $match: { "contract.country": "Spain" } },
  
  // Expandir pel√≠culas vistas
  { $unwind: "$movies" },
  
  // Obtener informaci√≥n de la pel√≠cula
  {
    $lookup: {
      from: "movies",
      localField: "movies.movieId",
      foreignField: "_id",
      as: "movieInfo"
    }
  },
  
  { $unwind: "$movieInfo" },
  
  // Expandir el cast de cada pel√≠cula
  { $unwind: "$movieInfo.details.cast.stars" },
  
  // Agrupar por actor
  {
    $group: {
      _id: "$movieInfo.details.cast.stars.name",
      timesWatched: { $sum: 1 },
      totalViewingPct: { $sum: "$movies.viewingPct" },
      avgViewingPct: { $avg: "$movies.viewingPct" },
      uniqueClients: { $addToSet: "$client.customerCode" },
      movies: {
        $addToSet: {
          title: "$movieInfo.title",
          year: "$movieInfo.details.year"
        }
      },
      facebookLikes: { $first: "$movieInfo.details.cast.stars.facebookLikes" }
    }
  },
  
  // Calcular m√©tricas adicionales
  {
    $addFields: {
      uniqueClientsCount: { $size: "$uniqueClients" },
      moviesCount: { $size: "$movies" }
    }
  },
  
  // Ordenar por veces visto
  { $sort: { timesWatched: -1 } },
  
  // Top 5
  { $limit: 5 },
  
  // Formato final
  {
    $project: {
      _id: 0,
      actor: "$_id",
      timesWatched: 1,
      uniqueClients: "$uniqueClientsCount",
      moviesCount: 1,
      avgViewingPct: { $round: ["$avgViewingPct", 2] },
      facebookLikes: 1,
      topMovies: { $slice: ["$movies", 5] }
    }
  }
]).forEach((doc, idx) => {
  print(`${idx + 1}. ${doc.actor}`);
  print(`   ‚Ä¢ Visionados totales: ${doc.timesWatched}`);
  print(`   ‚Ä¢ Clientes √∫nicos: ${doc.uniqueClients}`);
  print(`   ‚Ä¢ Pel√≠culas diferentes: ${doc.moviesCount}`);
  print(`   ‚Ä¢ Promedio de visionado: ${doc.avgViewingPct}%`);
  print(`   ‚Ä¢ Facebook Likes: ${doc.facebookLikes.toLocaleString()}`);
  print(`   ‚Ä¢ Pel√≠culas destacadas:`);
  doc.topMovies.forEach(movie => {
    print(`     - ${movie.title} (${movie.year})`);
  });
  print("");
});

print("‚úÖ Q3 completada\n");

// ============================================================================
// Q4) CL√ÅSICOS MODERNOS
// Top-10 anual de pel√≠culas del siglo XX m√°s vistas
// ============================================================================

print("üé¨ Q4: CL√ÅSICOS MODERNOS - Top-10 pel√≠culas del siglo XX m√°s vistas\n");
print("-".repeat(80));

db.invoices_restructured.aggregate([
  // Expandir pel√≠culas
  { $unwind: "$movies" },
  
  // Obtener informaci√≥n de la pel√≠cula
  {
    $lookup: {
      from: "movies",
      localField: "movies.movieId",
      foreignField: "_id",
      as: "movieInfo"
    }
  },
  
  { $unwind: "$movieInfo" },
  
  // Filtrar pel√≠culas del siglo XX (1900-1999)
  {
    $match: {
      "movieInfo.details.year": { $gte: 1900, $lte: 1999 }
    }
  },
  
  // Extraer a√±o de la factura
  {
    $addFields: {
      billingYear: { $year: "$billing" }
    }
  },
  
  // Agrupar por a√±o de facturaci√≥n y pel√≠cula
  {
    $group: {
      _id: {
        billingYear: "$billingYear",
        movieId: "$movies.movieId",
        movieTitle: "$movieInfo.title",
        movieYear: "$movieInfo.details.year"
      },
      viewCount: { $sum: 1 },
      avgViewingPct: { $avg: "$movies.viewingPct" },
      uniqueClients: { $addToSet: "$client.customerCode" },
      totalDuration: { $sum: "$movieInfo.details.duration" },
      imdbScore: { $first: "$movieInfo.details.imdbScore" },
      genres: { $first: "$movieInfo.details.genres" },
      director: { $first: "$movieInfo.details.director.name" }
    }
  },
  
  // Calcular clientes √∫nicos
  {
    $addFields: {
      uniqueClientsCount: { $size: "$uniqueClients" }
    }
  },
  
  // Ordenar por a√±o de facturaci√≥n y n√∫mero de visionados
  { $sort: { "_id.billingYear": -1, viewCount: -1 } },
  
  // Agrupar por a√±o de facturaci√≥n para obtener top-10 de cada a√±o
  {
    $group: {
      _id: "$_id.billingYear",
      topMovies: {
        $push: {
          title: "$_id.movieTitle",
          year: "$_id.movieYear",
          viewCount: "$viewCount",
          uniqueClients: "$uniqueClientsCount",
          avgViewingPct: { $round: ["$avgViewingPct", 2] },
          totalMinutes: "$totalDuration",
          imdbScore: "$imdbScore",
          genres: "$genres",
          director: "$director"
        }
      }
    }
  },
  
  // Limitar a top-10 por a√±o
  {
    $project: {
      _id: 0,
      year: "$_id",
      topMovies: { $slice: ["$topMovies", 10] }
    }
  },
  
  // Ordenar por a√±o descendente
  { $sort: { year: -1 } }
]).forEach(yearDoc => {
  print(`\nüìÖ A√ëO ${yearDoc.year}`);
  print("=".repeat(80));
  yearDoc.topMovies.forEach((movie, idx) => {
    print(`\n${idx + 1}. ${movie.title} (${movie.year})`);
    print(`   ‚Ä¢ Director: ${movie.director}`);
    print(`   ‚Ä¢ G√©neros: ${movie.genres.join(", ")}`);
    print(`   ‚Ä¢ IMDB Score: ${movie.imdbScore}`);
    print(`   ‚Ä¢ Visionados: ${movie.viewCount}`);
    print(`   ‚Ä¢ Clientes √∫nicos: ${movie.uniqueClients}`);
    print(`   ‚Ä¢ Promedio visto: ${movie.avgViewingPct}%`);
    print(`   ‚Ä¢ Duraci√≥n total vista: ${(movie.totalMinutes / 60).toFixed(1)} horas`);
  });
  print("");
});

print("‚úÖ Q4 completada\n");

// ============================================================================
// Q5) FACTURACI√ìN MENSUAL
// Total de ingresos en un mes espec√≠fico
// ============================================================================

print("üí∞ Q5: FACTURACI√ìN MENSUAL - Total de ingresos por mes\n");
print("-".repeat(80));

db.invoices_restructured.aggregate([
  // Extraer a√±o y mes de la facturaci√≥n
  {
    $addFields: {
      year: { $year: "$billing" },
      month: { $month: "$billing" }
    }
  },
  
  // Agrupar por a√±o y mes
  {
    $group: {
      _id: {
        year: "$year",
        month: "$month"
      },
      totalRevenue: { $sum: { $toDecimal: "$total" } },
      invoiceCount: { $sum: 1 },
      uniqueClients: { $addToSet: "$client.customerCode" },
      productTypes: {
        $push: "$contract.product.type"
      }
    }
  },
  
  // Calcular estad√≠sticas adicionales
  {
    $addFields: {
      uniqueClientsCount: { $size: "$uniqueClients" },
      avgRevenuePerInvoice: {
        $divide: ["$totalRevenue", "$invoiceCount"]
      }
    }
  },
  
  // Contar tipos de producto
  {
    $addFields: {
        productDistribution: {
        $reduce: {
            input: "$productTypes",
            initialValue: { "pay per content": 0 },
            in: {
            "pay per content": {
                $cond: [
                { $eq: ["$$this", "pay per content"] },
                { $add: ["$$value.pay per content", 1] },
                "$$value.pay per content"
                ]
            }
            }
        }
      }
    }
  },
  
  // Ordenar por a√±o y mes descendente
  { $sort: { "_id.year": -1, "_id.month": -1 } },
  
  // Limitar a √∫ltimos 12 meses
  { $limit: 12 },
  
  // Formato final
  {
    $project: {
      _id: 0,
      year: "$_id.year",
      month: "$_id.month",
      totalRevenue: { $round: ["$totalRevenue", 2] },
      invoiceCount: 1,
      uniqueClients: "$uniqueClientsCount",
      avgRevenuePerInvoice: { $round: ["$avgRevenuePerInvoice", 2] },
      productDistribution: 1
    }
  }
]).forEach(doc => {
  const monthNames = ["", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
  print(`\nüìä ${monthNames[doc.month]} ${doc.year}`);
  print("-".repeat(80));
  print(`  üíµ Ingresos totales: ‚Ç¨${doc.totalRevenue.toLocaleString()}`);
  print(`  üìÑ Facturas emitidas: ${doc.invoiceCount.toLocaleString()}`);
  print(`  üë• Clientes √∫nicos: ${doc.uniqueClients.toLocaleString()}`);
  print(`  üìà Ingreso promedio por factura: ‚Ç¨${parseFloat(doc.avgRevenuePerInvoice).toFixed(2)}`);
  print(`  üì¶ Distribuci√≥n por producto:`);
  print(`     ‚Ä¢ Pay per content: ${doc.productDistribution["pay per content"]}`);
});

print("\n‚úÖ Q5 completada\n");

// ============================================================================
// Q6) CONSUMO MENSUAL
// Total mensual de visionados (series vs pel√≠culas), incluyendo duraci√≥n en horas
// ============================================================================

print("üì∫ Q6: CONSUMO MENSUAL - Visionados y duraci√≥n total\n");
print("-".repeat(80));

db.invoices_restructured.aggregate([
  // Extraer a√±o y mes
  {
    $addFields: {
      year: { $year: "$billing" },
      month: { $month: "$billing" }
    }
  },
  
  // Crear documentos separados para pel√≠culas y series
  {
    $facet: {
      movies: [
        { $unwind: "$movies" },
        {
          $lookup: {
            from: "movies",
            localField: "movies.movieId",
            foreignField: "_id",
            as: "movieInfo"
          }
        },
        { $unwind: "$movieInfo" },
        {
          $group: {
            _id: {
              year: "$year",
              month: "$month"
            },
            movieViews: { $sum: 1 },
            movieDuration: { $sum: "$movieInfo.details.duration" },
            avgMovieViewingPct: { $avg: "$movies.viewingPct" },
            uniqueMovies: { $addToSet: "$movies.movieId" }
          }
        }
      ],
      series: [
        { $unwind: "$series" },
        {
          $lookup: {
            from: "series",
            localField: "series.seriesId",
            foreignField: "_id",
            as: "seriesInfo"
          }
        },
        { $unwind: "$seriesInfo" },
        {
          $group: {
            _id: {
              year: "$year",
              month: "$month"
            },
            seriesViews: { $sum: 1 },
            seriesDuration: { $sum: "$seriesInfo.avgDuration" },
            avgSeriesViewingPct: { $avg: "$series.viewingPct" },
            uniqueSeries: { $addToSet: "$series.seriesId" }
          }
        }
      ]
    }
  },
  
  // Unir los resultados
  {
    $project: {
      combined: {
        $concatArrays: [
          {
            $map: {
              input: "$movies",
              as: "m",
              in: {
                year: "$$m._id.year",
                month: "$$m._id.month",
                movieViews: "$$m.movieViews",
                movieDuration: "$$m.movieDuration",
                avgMovieViewingPct: "$$m.avgMovieViewingPct",
                uniqueMoviesCount: { $size: "$$m.uniqueMovies" },
                seriesViews: 0,
                seriesDuration: 0,
                avgSeriesViewingPct: 0,
                uniqueSeriesCount: 0
              }
            }
          },
          {
            $map: {
              input: "$series",
              as: "s",
              in: {
                year: "$$s._id.year",
                month: "$$s._id.month",
                movieViews: 0,
                movieDuration: 0,
                avgMovieViewingPct: 0,
                uniqueMoviesCount: 0,
                seriesViews: "$$s.seriesViews",
                seriesDuration: "$$s.seriesDuration",
                avgSeriesViewingPct: "$$s.avgSeriesViewingPct",
                uniqueSeriesCount: { $size: "$$s.uniqueSeries" }
              }
            }
          }
        ]
      }
    }
  },
  
  { $unwind: "$combined" },
  
  // Agrupar por a√±o y mes sumando ambos tipos
  {
    $group: {
      _id: {
        year: "$combined.year",
        month: "$combined.month"
      },
      movieViews: { $sum: "$combined.movieViews" },
      movieDurationMinutes: { $sum: "$combined.movieDuration" },
      avgMovieViewingPct: { $avg: "$combined.avgMovieViewingPct" },
      uniqueMoviesCount: { $sum: "$combined.uniqueMoviesCount" },
      seriesViews: { $sum: "$combined.seriesViews" },
      seriesDurationMinutes: { $sum: "$combined.seriesDuration" },
      avgSeriesViewingPct: { $avg: "$combined.avgSeriesViewingPct" },
      uniqueSeriesCount: { $sum: "$combined.uniqueSeriesCount" }
    }
  },
  
  // Calcular totales y porcentajes
  {
    $addFields: {
      totalViews: { $add: ["$movieViews", "$seriesViews"] },
      totalDurationMinutes: {
        $add: ["$movieDurationMinutes", "$seriesDurationMinutes"]
      },
      totalDurationHours: {
        $divide: [
          { $add: ["$movieDurationMinutes", "$seriesDurationMinutes"] },
          60
        ]
      },
      movieViewsPct: {
        $multiply: [
          {
            $divide: [
              "$movieViews",
              { $add: ["$movieViews", "$seriesViews"] }
            ]
          },
          100
        ]
      },
      seriesViewsPct: {
        $multiply: [
          {
            $divide: [
              "$seriesViews",
              { $add: ["$movieViews", "$seriesViews"] }
            ]
          },
          100
        ]
      }
    }
  },
  
  // Ordenar por fecha descendente
  { $sort: { "_id.year": -1, "_id.month": -1 } },
  
  // Limitar a √∫ltimos 12 meses
  { $limit: 12 },
  
  // Formato final
  {
    $project: {
      _id: 0,
      year: "$_id.year",
      month: "$_id.month",
      movies: {
        views: "$movieViews",
        uniqueTitles: "$uniqueMoviesCount",
        durationHours: { $round: [{ $divide: ["$movieDurationMinutes", 60] }, 2] },
        avgViewingPct: { $round: ["$avgMovieViewingPct", 2] },
        percentOfTotal: { $round: ["$movieViewsPct", 2] }
      },
      series: {
        views: "$seriesViews",
        uniqueTitles: "$uniqueSeriesCount",
        durationHours: { $round: [{ $divide: ["$seriesDurationMinutes", 60] }, 2] },
        avgViewingPct: { $round: ["$avgSeriesViewingPct", 2] },
        percentOfTotal: { $round: ["$seriesViewsPct", 2] }
      },
      total: {
        views: "$totalViews",
        durationHours: { $round: ["$totalDurationHours", 2] }
      }
    }
  }
]).forEach(doc => {
  const monthNames = ["", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
  print(`\nüìÖ ${monthNames[doc.month]} ${doc.year}`);
  print("=".repeat(80));
  print(`  üé¨ PEL√çCULAS:`);
  print(`     ‚Ä¢ Visionados: ${doc.movies.views.toLocaleString()} (${doc.movies.percentOfTotal}%)`);
  print(`     ‚Ä¢ T√≠tulos √∫nicos: ${doc.movies.uniqueTitles}`);
  print(`     ‚Ä¢ Duraci√≥n total: ${doc.movies.durationHours.toLocaleString()} horas`);
  print(`     ‚Ä¢ Promedio visto: ${doc.movies.avgViewingPct}%`);
  print(`  üì∫ SERIES:`);
  print(`     ‚Ä¢ Visionados: ${doc.series.views.toLocaleString()} (${doc.series.percentOfTotal}%)`);
  print(`     ‚Ä¢ T√≠tulos √∫nicos: ${doc.series.uniqueTitles}`);
  print(`     ‚Ä¢ Duraci√≥n total: ${doc.series.durationHours.toLocaleString()} horas`);
  print(`     ‚Ä¢ Promedio visto: ${doc.series.avgViewingPct}%`);
  print(`  üìä TOTAL:`);
  print(`     ‚Ä¢ Visionados totales: ${doc.total.views.toLocaleString()}`);
  print(`     ‚Ä¢ Duraci√≥n total: ${doc.total.durationHours.toLocaleString()} horas`);
  const avgHoursPerDay = (doc.total.durationHours / 30).toFixed(2);
  print(`     ‚Ä¢ Promedio diario: ${avgHoursPerDay} horas/d√≠a`);
});

print("\n‚úÖ Q6 completada\n");

// ============================================================================
// Q7) PEL√çCULAS EXITOSAS
// N√∫mero total de visionados y duraci√≥n acumulada para una pel√≠cula concreta
// (A√±adiendo estos campos al documento de la pel√≠cula)
// ============================================================================

print("üèÜ Q7: PEL√çCULAS EXITOSAS - Estad√≠sticas de visionado\n");
print("-".repeat(80));

// Primero calculamos las estad√≠sticas
var movieStats = db.invoices_restructured.aggregate([
  { $unwind: "$movies" },
  
  {
    $lookup: {
      from: "movies",
      localField: "movies.movieId",
      foreignField: "_id",
      as: "movieInfo"
    }
  },
  
  { $unwind: "$movieInfo" },
  
  {
    $group: {
      _id: "$movies.movieId",
      title: { $first: "$movieInfo.title" },
      year: { $first: "$movieInfo.details.year" },
      duration: { $first: "$movieInfo.details.duration" },
      totalViews: { $sum: 1 },
      uniqueClients: { $addToSet: "$client.customerCode" },
      avgViewingPct: { $avg: "$movies.viewingPct" },
      totalViewingMinutes: {
        $sum: {
          $multiply: [
            "$movieInfo.details.duration",
            { $divide: ["$movies.viewingPct", 100] }
          ]
        }
      },
      viewsByMonth: {
        $push: {
          month: { $month: "$movies.date" },
          year: { $year: "$movies.date" }
        }
      },
      imdbScore: { $first: "$movieInfo.details.imdbScore" },
      genres: { $first: "$movieInfo.details.genres" },
      director: { $first: "$movieInfo.details.director.name" }
    }
  },
  
  {
    $addFields: {
      uniqueClientsCount: { $size: "$uniqueClients" },
      totalViewingHours: { $divide: ["$totalViewingMinutes", 60] },
      avgViewsPerClient: {
        $divide: ["$totalViews", { $size: "$uniqueClients" }]
      }
    }
  },
  
  // Ordenar por total de visionados
  { $sort: { totalViews: -1 } },
  
  // Top 20 pel√≠culas m√°s vistas
  { $limit: 20 },
  
  {
    $project: {
      _id: 0,
      movieId: "$_id",
      title: 1,
      year: 1,
      duration: 1,
      director: 1,
      genres: 1,
      imdbScore: 1,
      viewingStats: {
        totalViews: "$totalViews",
        uniqueClients: "$uniqueClientsCount",
        avgViewsPerClient: { $round: ["$avgViewsPerClient", 2] },
        avgViewingPct: { $round: ["$avgViewingPct", 2] },
        totalViewingHours: { $round: ["$totalViewingHours", 2] },
        estimatedCompletions: {
          $round: [
            {
              $multiply: [
                "$totalViews",
                { $divide: ["$avgViewingPct", 100] }
              ]
            },
            0
          ]
        }
      }
    }
  }
]).toArray();

// Mostrar resultados
movieStats.forEach((movie, idx) => {
  print(`\n${idx + 1}. ${movie.title} (${movie.year})`);
  print("-".repeat(80));
  print(`  üé¨ Informaci√≥n b√°sica:`);
  print(`     ‚Ä¢ Director: ${movie.director}`);
  print(`     ‚Ä¢ G√©neros: ${movie.genres.join(", ")}`);
  print(`     ‚Ä¢ Duraci√≥n: ${movie.duration} minutos`);
  print(`     ‚Ä¢ IMDB Score: ${movie.imdbScore}`);
  print(`  üìä Estad√≠sticas de visionado:`);
  print(`     ‚Ä¢ Visionados totales: ${movie.viewingStats.totalViews.toLocaleString()}`);
  print(`     ‚Ä¢ Clientes √∫nicos: ${movie.viewingStats.uniqueClients.toLocaleString()}`);
  print(`     ‚Ä¢ Promedio de visionados por cliente: ${movie.viewingStats.avgViewsPerClient}`);
  print(`     ‚Ä¢ Porcentaje promedio visto: ${movie.viewingStats.avgViewingPct}%`);
  print(`     ‚Ä¢ Horas totales vistas: ${movie.viewingStats.totalViewingHours.toLocaleString()} horas`);
  print(`     ‚Ä¢ Visionados completos estimados: ${movie.viewingStats.estimatedCompletions}`);
  
  // Calcular m√©trica de √©xito
  const successScore = (
    (movie.viewingStats.totalViews * 0.4) +
    (movie.viewingStats.uniqueClients * 0.3) +
    (movie.viewingStats.avgViewingPct * 0.3)
  );
  print(`     ‚Ä¢ √çndice de √©xito: ${successScore.toFixed(2)}`);
});

// Opcional: Actualizar la colecci√≥n movies con estas estad√≠sticas
print("\n\nüíæ ¬øDesea actualizar la colecci√≥n 'movies' con estas estad√≠sticas?");
print("   Ejecute el siguiente c√≥digo para actualizar:");
print("\n   movieStats.forEach(movie => {");
print("     db.movies.updateOne(");
print("       { _id: movie.movieId },");
print("       {");
print("         $set: {");
print("           'analytics': movie.viewingStats,");
print("           '_metadata.lastAnalyticsUpdate': new Date()");
print("         }");
print("       }");
print("     );");
print("   });\n");

print("‚úÖ Q7 completada\n");

// ============================================================================
// Q8) FRACASO EN SERIES
// Promedio de porcentaje visto por usuario en cada serie para analizar abandono
// ============================================================================

print("üìâ Q8: FRACASO EN SERIES - An√°lisis de abandono por serie\n");
print("-".repeat(80));

db.invoices_restructured.aggregate([
  // Expandir series
  { $unwind: "$series" },
  
  // Obtener informaci√≥n de la serie
  {
    $lookup: {
      from: "series",
      localField: "series.seriesId",
      foreignField: "_id",
      as: "seriesInfo"
    }
  },
  
  { $unwind: "$seriesInfo" },
  
  // Agrupar por serie y cliente
  {
    $group: {
      _id: {
        seriesId: "$series.seriesId",
        customerCode: "$client.customerCode"
      },
      seriesTitle: { $first: "$seriesInfo.title" },
      totalSeasons: { $first: "$seriesInfo.totalSeasons" },
      totalEpisodes: { $first: "$seriesInfo.totalEpisodes" },
      avgDuration: { $first: "$seriesInfo.avgDuration" },
      episodesWatched: { $sum: 1 },
      avgViewingPct: { $avg: "$series.viewingPct" },
      maxSeason: { $max: "$series.season" },
      minSeason: { $min: "$series.season" },
      seasons: { $addToSet: "$series.season" }
    }
  },
  
  // Calcular m√©tricas por cliente
  {
    $addFields: {
      seasonsWatchedCount: { $size: "$seasons" },
      completionRate: {
        $divide: [
          "$episodesWatched",
          "$totalEpisodes"
        ]
      },
      seasonPenetration: {
        $divide: [
          { $size: "$seasons" },
          "$totalSeasons"
        ]
      }
    }
  },
  
  // Agrupar por serie para obtener estad√≠sticas globales
  {
    $group: {
      _id: "$_id.seriesId",
      title: { $first: "$seriesTitle" },
      totalSeasons: { $first: "$totalSeasons" },
      totalEpisodes: { $first: "$totalEpisodes" },
      avgDuration: { $first: "$avgDuration" },
      totalViewers: { $sum: 1 },
      avgViewingPctPerUser: { $avg: "$avgViewingPct" },
      avgEpisodesPerUser: { $avg: "$episodesWatched" },
      avgCompletionRate: { $avg: "$completionRate" },
      avgSeasonPenetration: { $avg: "$seasonPenetration" },
      viewersByCompletion: {
        $push: {
          customerCode: "$_id.customerCode",
          episodesWatched: "$episodesWatched",
          avgViewingPct: "$avgViewingPct",
          seasonsWatched: "$seasonsWatchedCount",
          completionRate: "$completionRate"
        }
      }
    }
  },
  
  // Calcular categor√≠as de abandono
  {
    $addFields: {
      abandonmentRate: {
        $subtract: [1, "$avgCompletionRate"]
      },
      earlyAbandonmentCount: {
        $size: {
          $filter: {
            input: "$viewersByCompletion",
            as: "viewer",
            cond: { $lt: ["$viewer.completionRate", 0.1] }
          }
        }
      },
      midAbandonmentCount: {
        $size: {
          $filter: {
            input: "$viewersByCompletion",
            as: "viewer",
            cond: {
              $and: [
                { $gte: ["$viewer.completionRate", 0.1] },
                { $lt: ["$viewer.completionRate", 0.5] }
              ]
            }
          }
        }
      },
      lateAbandonmentCount: {
        $size: {
          $filter: {
            input: "$viewersByCompletion",
            as: "viewer",
            cond: {
              $and: [
                { $gte: ["$viewer.completionRate", 0.5] },
                { $lt: ["$viewer.completionRate", 0.9] }
              ]
            }
          }
        }
      },
      completersCount: {
        $size: {
          $filter: {
            input: "$viewersByCompletion",
            as: "viewer",
            cond: { $gte: ["$viewer.completionRate", 0.9] }
          }
        }
      }
    }
  },
  
  // Calcular √≠ndice de abandono (0-100, donde 100 es peor)
  {
    $addFields: {
      abandonmentIndex: {
        $multiply: [
          {
            $add: [
              // Peso del abandono general
              { $multiply: ["$abandonmentRate", 40] },
              // Peso del abandono temprano
              {
                $multiply: [
                  { $divide: ["$earlyAbandonmentCount", "$totalViewers"] },
                  30
                ]
              },
              // Peso del viewing pct bajo
              {
                $multiply: [
                  { $divide: [{ $subtract: [100, "$avgViewingPctPerUser"] }, 100] },
                  30
                ]
              }
            ]
          },
          100
        ]
      }
    }
  },
  
  // Ordenar por √≠ndice de abandono (peores primero)
  { $sort: { abandonmentIndex: -1 } },
  
  // Top 30 series con mayor abandono
  { $limit: 30 },
  
  // Formato final
  {
    $project: {
      _id: 0,
      title: 1,
      totalSeasons: 1,
      totalEpisodes: 1,
      avgDuration: 1,
      metrics: {
        totalViewers: "$totalViewers",
        avgViewingPctPerUser: { $round: ["$avgViewingPctPerUser", 2] },
        avgEpisodesPerUser: { $round: ["$avgEpisodesPerUser", 2] },
        avgCompletionRate: { $round: [{ $multiply: ["$avgCompletionRate", 100] }, 2] },
        avgSeasonPenetration: { $round: [{ $multiply: ["$avgSeasonPenetration", 100] }, 2] },
        abandonmentRate: { $round: [{ $multiply: ["$abandonmentRate", 100] }, 2] },
        abandonmentIndex: { $round: ["$abandonmentIndex", 2] }
      },
      abandonmentBreakdown: {
        earlyAbandonment: {
          count: "$earlyAbandonmentCount",
          percentage: {
            $round: [
              { $multiply: [{ $divide: ["$earlyAbandonmentCount", "$totalViewers"] }, 100] },
              2
            ]
          }
        },
        midAbandonment: {
          count: "$midAbandonmentCount",
          percentage: {
            $round: [
              { $multiply: [{ $divide: ["$midAbandonmentCount", "$totalViewers"] }, 100] },
              2
            ]
          }
        },
        lateAbandonment: {
          count: "$lateAbandonmentCount",
          percentage: {
            $round: [
              { $multiply: [{ $divide: ["$lateAbandonmentCount", "$totalViewers"] }, 100] },
              2
            ]
          }
        },
        completers: {
          count: "$completersCount",
          percentage: {
            $round: [
              { $multiply: [{ $divide: ["$completersCount", "$totalViewers"] }, 100] },
              2
            ]
          }
        }
      }
    }
  }
]).forEach((series, idx) => {
  print(`\n${idx + 1}. ${series.title}`);
  print("-".repeat(80));
  print(`  üì∫ Informaci√≥n b√°sica:`);
  print(`     ‚Ä¢ Temporadas: ${series.totalSeasons}`);
  print(`     ‚Ä¢ Episodios totales: ${series.totalEpisodes}`);
  print(`     ‚Ä¢ Duraci√≥n promedio: ${series.avgDuration} min/episodio`);
  
  print(`  üë• M√©tricas de audiencia:`);
  print(`     ‚Ä¢ Espectadores totales: ${series.metrics.totalViewers.toLocaleString()}`);
  print(`     ‚Ä¢ Episodios promedio por usuario: ${series.metrics.avgEpisodesPerUser}`);
  print(`     ‚Ä¢ Porcentaje promedio visto: ${series.metrics.avgViewingPctPerUser}%`);
  print(`     ‚Ä¢ Tasa de completaci√≥n: ${series.metrics.avgCompletionRate}%`);
  print(`     ‚Ä¢ Penetraci√≥n de temporadas: ${series.metrics.avgSeasonPenetration}%`);
  
  print(`  üìâ An√°lisis de abandono:`);
  print(`     ‚Ä¢ Tasa de abandono general: ${series.metrics.abandonmentRate}%`);
  print(`     ‚Ä¢ √çndice de abandono: ${series.metrics.abandonmentIndex}/100 ${
    series.metrics.abandonmentIndex > 70 ? 'üî¥ CR√çTICO' :
    series.metrics.abandonmentIndex > 50 ? 'üü° ALTO' :
    series.metrics.abandonmentIndex > 30 ? 'üü¢ MODERADO' : '‚úÖ BAJO'
  }`);
  
  print(`  üìä Distribuci√≥n del abandono:`);
  print(`     ‚Ä¢ Abandono temprano (<10%): ${series.abandonmentBreakdown.earlyAbandonment.count} (${series.abandonmentBreakdown.earlyAbandonment.percentage}%)`);
  print(`     ‚Ä¢ Abandono medio (10-50%): ${series.abandonmentBreakdown.midAbandonment.count} (${series.abandonmentBreakdown.midAbandonment.percentage}%)`);
  print(`     ‚Ä¢ Abandono tard√≠o (50-90%): ${series.abandonmentBreakdown.lateAbandonment.count} (${series.abandonmentBreakdown.lateAbandonment.percentage}%)`);
  print(`     ‚Ä¢ Completaron (>90%): ${series.abandonmentBreakdown.completers.count} (${series.abandonmentBreakdown.completers.percentage}%)`);
  
  // Diagn√≥stico y recomendaciones
  print(`  üí° Diagn√≥stico:`);
  if (series.abandonmentBreakdown.earlyAbandonment.percentage > 50) {
    print(`     ‚ö†Ô∏è  M√ÅS DEL 50% ABANDONA EN LOS PRIMEROS EPISODIOS`);
    print(`     ‚Üí Problema: Primeros episodios no enganchan`);
    print(`     ‚Üí Recomendaci√≥n: Revisar ritmo y gancho inicial`);
  } else if (series.abandonmentBreakdown.midAbandonment.percentage > 40) {
    print(`     ‚ö†Ô∏è  ALTO ABANDONO EN LA MITAD DE LA SERIE`);
    print(`     ‚Üí Problema: P√©rdida de inter√©s en desarrollo`);
    print(`     ‚Üí Recomendaci√≥n: Mejorar arcos narrativos medios`);
  } else if (series.metrics.avgViewingPctPerUser < 60) {
    print(`     ‚ö†Ô∏è  LOS USUARIOS VEN MENOS DEL 60% DE CADA EPISODIO`);
    print(`     ‚Üí Problema: Contenido no retiene atenci√≥n`);
    print(`     ‚Üí Recomendaci√≥n: Contenido puede ser aburrido o lento`);
  } else if (series.abandonmentBreakdown.completers.percentage > 40) {
    print(`     ‚úÖ M√ÅS DEL 40% COMPLETA LA SERIE`);
    print(`     ‚Üí Serie exitosa con buena retenci√≥n`);
  } else {
    print(`     ‚ö†Ô∏è  ABANDONO DISTRIBUIDO EN DIFERENTES ETAPAS`);
    print(`     ‚Üí Problema: Calidad inconsistente`);
    print(`     ‚Üí Recomendaci√≥n: Auditar temporadas individuales`);
  }
});

print("\n\n‚úÖ Q8 completada\n");

// ============================================================================
// RESUMEN FINAL
// ============================================================================

print("\n" + "=".repeat(80));
print("RESUMEN DE CONSULTAS DE AGREGACI√ìN");
print("=".repeat(80) + "\n");

print("‚úÖ Consultas implementadas:");
print("   Q1. Serial Lovers - Clientes que completaron temporadas");
print("   Q2. Apellidos comunes - Apellido m√°s frecuente por pa√≠s");
print("   Q3. Actores populares - Top-5 actores m√°s vistos en Espa√±a");
print("   Q4. Cl√°sicos modernos - Top-10 pel√≠culas del siglo XX por a√±o");
print("   Q5. Facturaci√≥n mensual - Ingresos totales por mes");
print("   Q6. Consumo mensual - Visionados y duraci√≥n (series vs pel√≠culas)");
print("   Q7. Pel√≠culas exitosas - Estad√≠sticas de visionado por pel√≠cula");
print("   Q8. Fracaso en series - An√°lisis de abandono y engagement");

print("\nüìä Capacidades implementadas:");
print("   ‚Ä¢ An√°lisis de comportamiento de usuarios");
print("   ‚Ä¢ M√©tricas de engagement y retenci√≥n");
print("   ‚Ä¢ An√°lisis de contenido m√°s popular");
print("   ‚Ä¢ Estad√≠sticas financieras y de consumo");
print("   ‚Ä¢ Detecci√≥n de patrones de abandono");
print("   ‚Ä¢ Segmentaci√≥n por geograf√≠a y demograf√≠a");
print("   ‚Ä¢ An√°lisis temporal (mensual, anual)");
print("   ‚Ä¢ Lookups entre colecciones relacionadas");

print("\nüéØ Casos de uso empresariales:");
print("   ‚Ä¢ Identificar contenido de alto valor");
print("   ‚Ä¢ Detectar contenido con problemas de calidad");
print("   ‚Ä¢ Optimizar cat√°logo seg√∫n preferencias");
print("   ‚Ä¢ An√°lisis de ROI por contenido");
print("   ‚Ä¢ Segmentaci√≥n de clientes");
print("   ‚Ä¢ Predicci√≥n de churn");
print("   ‚Ä¢ Recomendaciones personalizadas");

print("\nüí° Optimizaciones aplicadas:");
print("   ‚Ä¢ Uso de √≠ndices en campos de agregaci√≥n");
print("   ‚Ä¢ Proyecciones para reducir datos procesados");
print("   ‚Ä¢ L√≠mites en resultados para rendimiento");
print("   ‚Ä¢ Facets para agregaciones paralelas");
print("   ‚Ä¢ Lookups eficientes con pipeline");

print("\nüîß Pr√≥ximos pasos sugeridos:");
print("   1. Crear vistas materializadas para consultas frecuentes");
print("   2. Implementar cache para resultados de Q5 y Q6");
print("   3. Agregar time-series collections para m√©tricas");
print("   4. Crear dashboard con estas m√©tricas");
print("   5. Implementar alertas autom√°ticas para abandono alto");

print("\n" + "=".repeat(80));
print("FECHA DE EJECUCI√ìN: " + new Date().toISOString());
print("BASE DE DATOS: streamit_db");
print("COLECCIONES: movies, series, invoices_restructured");
print("=".repeat(80) + "\n");